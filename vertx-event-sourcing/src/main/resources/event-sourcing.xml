<databaseChangeLog
  xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
  xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
  xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
  http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.4.xsd"
>
  <!-- Entity table -->
  <changeSet id="${entity}-entity-table" author="reeferman" context="vertx">
    <createSequence sequenceName="${entity}_event_journal_seq" schemaName="${schema}"/>
    <createTable tableName="${entity}_event_journal" schemaName="${schema}">
      <column type="text" name="entity_id"/>
      <column type="text" name="event_class"/>
      <column type="text" name="command_class"/>
      <column type="bigint" name="event_version"/>
      <column type="jsonb" name="event"/>
      <column type="jsonb" name="command"/>
      <!--  Repository Entity    -->
      <column type="bigint" name="id" defaultValueSequenceNext="${entity}_event_journal_seq"/>
      <column type="text" name="tenant"/>
      <column type="timestamp" name="creation_date" defaultValueComputed="current_timestamp"/>
      <column type="timestamp" name="last_update" defaultValueComputed="current_timestamp"/>
      <column type="int" name="version" defaultValue="0"/>
    </createTable>
  </changeSet>
  <changeSet id="${entity}-event-journal-indexes" author="reeferman" context="vertx">
    <addPrimaryKey tableName="${entity}_event_journal" columnNames="entity_id, event_version, tenant"
                   schemaName="${schema}"/>
    <createIndex tableName="${entity}_event_journal" indexName="${entity}-index-2" schemaName="${schema}">
      <column name="entity_id"/>
      <column name="tenant"/>
    </createIndex>
    <createIndex tableName="${entity}_event_journal" indexName="${entity}-index-3" schemaName="${schema}">
      <column name="event_class"/>
      <column name="entity_id"/>
      <column name="tenant"/>
    </createIndex>
    <createIndex tableName="${entity}_event_journal" indexName="${entity}-index-4" schemaName="${schema}">
      <column name="command_class"/>
      <column name="entity_id"/>
      <column name="tenant"/>
    </createIndex>
  </changeSet>
  <!--  -->

  <!--  Rejected commands table-->
  <changeSet id="${entity}-rejected-commands-table" author="reeferman" context="vertx">
    <createSequence sequenceName="${entity}_rejected_commands_seq" schemaName="${schema}"/>
    <createTable tableName="${entity}_rejected_commands" schemaName="${schema}">
      <column type="text" name="entity_id"/>
      <column type="text" name="command_class"/>
      <column type="jsonb" name="error"/>
      <column type="jsonb" name="command"/>
      <!--  Repository Entity    -->
      <column type="bigint" name="id" defaultValueSequenceNext="${entity}_rejected_commands_seq"/>
      <column type="text" name="tenant"/>
      <column type="timestamp" name="creation_date" defaultValueComputed="current_timestamp"/>
      <column type="timestamp" name="last_update" defaultValueComputed="current_timestamp"/>
      <column type="int" name="version" defaultValue="0"/>
    </createTable>
  </changeSet>
  <changeSet id="${entity}-rejected-commands-indexes" author="reeferman" context="vertx">
    <createIndex tableName="${entity}_rejected_commands" indexName="${entity}-reject-command-index-1"
                 schemaName="${schema}">
      <column name="entity_id"/>
      <column name="tenant"/>
      <column name="command_class"/>
    </createIndex>
    <createIndex tableName="${entity}_rejected_commands" indexName="${entity}-rejected-command-index-2"
                 schemaName="${schema}">
      <column name="entity_id"/>
      <column name="tenant"/>
    </createIndex>
  </changeSet>
  <!--  -->

  <!-- Snapshots table -->
  <changeSet id="${entity}-snapshots-table" author="reeferman" context="vertx">
    <createSequence sequenceName="${entity}_snapshots_seq" schemaName="${schema}"/>
    <createTable tableName="${entity}_snapshots" schemaName="${schema}">
      <column type="text" name="entity_id"/>
      <column type="bigint" name="event_version"/>
      <column type="jsonb" name="state"/>
      <!--  Repository Entity    -->
      <column type="bigint" name="id" defaultValueSequenceNext="${entity}_snapshots_seq"/>
      <column type="text" name="tenant"/>
      <column type="timestamp" name="creation_date" defaultValueComputed="current_timestamp"/>
      <column type="timestamp" name="last_update" defaultValueComputed="current_timestamp"/>
      <column type="int" name="version" defaultValue="0"/>
    </createTable>
  </changeSet>
  <changeSet id="${entity}-snapshots-indexes" author="reeferman" context="vertx">
    <addPrimaryKey tableName="${entity}_snapshots" columnNames="entity_id, tenant" schemaName="${schema}"/>
  </changeSet>
  <!--  -->

  <!--  Event consumers offset -->
  <changeSet id="${entity}-consumers-offset-table" author="reeferman" context="vertx">
    <createSequence sequenceName="${entity}_consumers_offset_seq" schemaName="${schema}"/>
    <createTable tableName="${entity}_consumers_offset" schemaName="${schema}">
      <column type="text" name="consumer"/>
      <column type="bigint" name="offset"/>
      <!--  Repository Entity    -->
      <column type="bigint" name="id" defaultValueSequenceNext="${entity}_consumers_offset_seq"/>
      <column type="text" name="tenant"/>
      <column type="timestamp" name="creation_date" defaultValueComputed="current_timestamp"/>
      <column type="timestamp" name="last_update" defaultValueComputed="current_timestamp"/>
      <column type="int" name="version" defaultValue="0"/>
    </createTable>
  </changeSet>
  <changeSet id="${entity}-consumer-offset-indexes" author="reeferman" context="vertx">
    <addPrimaryKey tableName="${entity}_consumers_offset" columnNames="consumer, tenant" schemaName="${schema}"/>
  </changeSet>
  <!--  -->
</databaseChangeLog>
