<databaseChangeLog
  xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
  xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
  xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
  http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.4.xsd"
>
  <!-- EventJournal -->
  <changeSet id="event-journal-table" author="reeferman" context="vertx">
    <createSequence sequenceName="event_journal_seq" schemaName="eventx"/>
    <createTable tableName="event_journal" schemaName="eventx">
      <column type="bigint" name="id" defaultValueSequenceNext="event_journal_seq"/>
      <column type="text" name="aggregate_class"/>
      <column type="text" name="aggregate_id"/>
      <column type="text" name="event_class"/>
      <column type="bigint" name="event_version"/>
      <column type="jsonb" name="event"/>
      <column type="text" name="command_id"/>
      <column type="varchar(20) []" name="tags"/>
      <!--  Repository Entity    -->
      <column type="text" name="tenant"/>
      <column type="timestamp" name="creation_date" defaultValueComputed="current_timestamp"/>
      <column type="timestamp" name="last_update" defaultValueComputed="current_timestamp"/>
      <column type="int" name="version" defaultValue="0"/>
    </createTable>
  </changeSet>
  <changeSet id="event-journal-indexes" author="reeferman" context="vertx">
    <addPrimaryKey tableName="event_journal" columnNames="id" schemaName="eventx"/>
    <addUniqueConstraint tableName="event_journal" columnNames="aggregate_class, aggregate_id, event_version"
                         schemaName="eventx"/>
    <createIndex tableName="event_journal" indexName="index-2" schemaName="eventx">
      <column name="aggregate_id"/>
      <column name="aggregate_class"/>
      <column name="tenant"/>
    </createIndex>
    <createIndex tableName="event_journal" indexName="index-3" schemaName="eventx">
      <column name="event_class"/>
      <column name="aggregate_class"/>
      <column name="aggregate_id"/>
      <column name="tags"/>
      <column name="tenant"/>
    </createIndex>
    <createIndex tableName="event_journal" indexName="index-4" schemaName="eventx">
      <column name="command_id"/>
      <column name="tenant"/>
    </createIndex>
  </changeSet>
  <!--  -->

  <!-- Snapshots table -->
  <changeSet id="snapshots-table" author="reeferman" context="vertx">
    <createTable tableName="snapshots" schemaName="eventx">
      <column type="text" name="aggregate_id"/>
      <column type="text" name="aggregate_class"/>
      <column type="bigint" name="event_version"/>
      <column type="bigint" name="event_version"/>
      <column type="jsonb" name="state"/>
      <!--  Repository Entity    -->
      <column type="text" name="tenant"/>
      <column type="timestamp" name="creation_date" defaultValueComputed="current_timestamp"/>
      <column type="timestamp" name="last_update" defaultValueComputed="current_timestamp"/>
      <column type="int" name="version" defaultValue="0"/>
    </createTable>
  </changeSet>
  <changeSet id="snapshots-indexes" author="reeferman" context="vertx">
    <addPrimaryKey tableName="snapshots" columnNames="aggregate_id,aggregate_class, tenant" schemaName="eventx"/>
  </changeSet>
  <!--  -->

  <!--  Event consumers offset -->
  <changeSet id="consumers-offset-table" author="reeferman" context="vertx">
    <createTable tableName="consumers_offset" schemaName="eventx">
      <column type="text" name="consumer"/>
      <column type="bigint" name="offset"/>
      <!--  Repository Entity    -->
      <column type="text" name="tenant"/>
      <column type="timestamp" name="creation_date" defaultValueComputed="current_timestamp"/>
      <column type="timestamp" name="last_update" defaultValueComputed="current_timestamp"/>
      <column type="int" name="version" defaultValue="0"/>
    </createTable>
  </changeSet>
  <changeSet id="consumer-offset-indexes" author="reeferman" context="vertx">
    <addPrimaryKey tableName="consumers_offset" columnNames="consumer, tenant" schemaName="eventx"/>
  </changeSet>
  <!--  -->

  <!-- Projection offset -->
  <changeSet id="journal-offset-table" author="reeferman" context="vertx">
    <createTable tableName="journal_offset" schemaName="eventx">
      <column type="text" name="aggregate_class"/>
      <column type="text" name="aggregate_id"/>
      <column type="text" name="eventProjection"/>
      <column type="bigint" name="current_aggregate_version"/>
      <column type="bigint" name="current_journal_offset"/>
      <!--  Repository Entity    -->
      <column type="text" name="tenant"/>
      <column type="timestamp" name="creation_date" defaultValueComputed="current_timestamp"/>
      <column type="timestamp" name="last_update" defaultValueComputed="current_timestamp"/>
      <column type="int" name="version" defaultValue="0"/>
    </createTable>
  </changeSet>
  <changeSet id="stateProjection-offset-indexes" author="reeferman" context="vertx">
    <addPrimaryKey tableName="projection_offset" columnNames="aggregate_class, stateProjection, tenant" schemaName="eventx"/>
  </changeSet>
  <!--  -->
</databaseChangeLog>
